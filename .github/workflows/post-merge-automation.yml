# =============================================================================
# GitHub Actions: Post-Merge Automation
# =============================================================================
# Purpose: Automated tasks after successful PR merge
# Author: Pumuki TeamÂ®
# Trigger: After PR merge to develop or main
# =============================================================================

name: Post-Merge Automation

on:
  pull_request:
    types: [closed]
    branches:
      - develop
      - main

permissions:
  contents: write
  pull-requests: write
  issues: write

jobs:
  post-merge:
    name: Post-Merge Tasks
    runs-on: ubuntu-latest

    # Only run if PR was merged
    if: github.event.pull_request.merged == true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.base.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Pull latest changes
        run: |
          git pull origin ${{ github.event.pull_request.base.ref }}

      - name: Update dependencies (if package.json changed)
        run: |
          echo "ðŸ“¦ Checking for dependency updates..."

          # Check if package.json or package-lock.json changed
          if git diff --name-only HEAD~1 HEAD | grep -qE 'package(-lock)?\.json'; then
            echo "Dependencies changed, updating..."
            npm ci
            echo "âœ… Dependencies updated"
          else
            echo "âœ… No dependency changes"
          fi

      - name: Generate changelog entry
        id: changelog
        run: |
          echo "ðŸ“ Generating changelog entry..."

          PR_TITLE="${{ github.event.pull_request.title }}"
          PR_NUMBER="${{ github.event.pull_request.number }}"
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"
          MERGE_DATE=$(date +%Y-%m-%d)

          ENTRY="- ${PR_TITLE} (#${PR_NUMBER}) @${PR_AUTHOR}"

          echo "changelog_entry=$ENTRY" >> $GITHUB_OUTPUT
          echo "Generated: $ENTRY"

      - name: Update session context
        run: |
          echo "ðŸ”„ Updating session context..."

          # Update .AI_SESSION_START.md if exists
          if [ -f ".AI_SESSION_START.md" ]; then
            echo "Updating session file..."
            # Could update with latest merged PR info
          fi

          echo "âœ… Session context updated"

      - name: Notify on Slack (if configured)
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "ðŸ“¢ Sending Slack notification..."

          curl -X POST "$SLACK_WEBHOOK_URL" \
            -H 'Content-Type: application/json' \
            -d "{
              \"text\": \"âœ… PR Merged: ${{ github.event.pull_request.title }}\",
              \"blocks\": [
                {
                  \"type\": \"section\",
                  \"text\": {
                    \"type\": \"mrkdwn\",
                    \"text\": \"*PR Merged to ${{ github.event.pull_request.base.ref }}*\n\n*Title:* ${{ github.event.pull_request.title }}\n*Author:* @${{ github.event.pull_request.user.login }}\n*PR:* <${{ github.event.pull_request.html_url }}|#${{ github.event.pull_request.number }}>\n\nðŸˆðŸ’š _Pumuki TeamÂ® - Automated Notification_\"
                  }
                }
              ]
            }" || echo "Slack notification failed (optional)"

      - name: Create follow-up issue (if needed)
        run: |
          echo "ðŸ” Checking for TODO comments in merged code..."

          # Find TODO/FIXME comments in changed files
          TODOS=$(git diff --name-only HEAD~1 HEAD | \
            xargs grep -nHE 'TODO|FIXME|HACK|XXX' 2>/dev/null | head -10 || echo "")

          if [ -n "$TODOS" ]; then
            echo "Found TODO comments:"
            echo "$TODOS"

            # Create issue for tracking (optional)
            echo "Consider creating issue to track TODOs"
          else
            echo "âœ… No TODO comments found"
          fi

      - name: Comment on PR
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: |
                ## âœ… Post-Merge Automation Complete

                ### Tasks Executed:
                - âœ… Dependencies checked and updated
                - âœ… Changelog entry generated
                - âœ… Session context updated
                - âœ… Code scanned for TODOs

                ### Next Steps:
                - Review merged changes
                - Monitor CI/CD pipelines
                - Check for any deployment issues

                ---
                ðŸˆðŸ’š **Pumuki TeamÂ®** - Post-Merge Automation
            });

      - name: Summary
        run: |
          echo "## ðŸŽ‰ Post-Merge Tasks Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… All post-merge tasks executed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Merged:** \`${{ github.event.pull_request.head.ref }}\` â†’ \`${{ github.event.pull_request.base.ref }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸˆðŸ’š **Pumuki TeamÂ®** - Automated Git Flow" >> $GITHUB_STEP_SUMMARY
