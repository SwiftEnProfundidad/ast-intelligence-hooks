name: Auto PR develop -> main

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  create-or-update-pr:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create or update PR develop -> main
        id: pr
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            // Find existing open PR from develop to main
            const { data: prs } = await github.rest.pulls.list({ owner, repo, state: 'open', head: `${owner}:develop`, base: 'main' });
            if (prs.length > 0) {
              const pr = prs[0];
              core.info(`Found existing PR #${pr.number}`);
              core.setOutput('number', pr.number.toString());
              core.setOutput('node_id', pr.node_id);
            } else {
              const title = 'feat(web): sync develop -> main (auto)';
              const body = [
                'This PR was created automatically to sync develop into main.',
                '',
                'Includes:',
                '- PWA manifest & icons',
                '- Default dark theme without FOUC',
                '- UI alignment improvements',
                '',
                'It will be auto-merged once required checks pass.'
              ].join('\n');
              const { data: pr } = await github.rest.pulls.create({ owner, repo, head: 'develop', base: 'main', title, body });
              core.info(`Created PR #${pr.number}`);
              core.setOutput('number', pr.number.toString());
              core.setOutput('node_id', pr.node_id);
            }

      - name: Enable auto-merge (squash)
        if: steps.pr.outputs.node_id != ''
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = Number('${{ steps.pr.outputs.number }}');
            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: number });
            const nodeId = pr.node_id;
            try {
              await github.graphql(`
                mutation($prId: ID!) {
                  enablePullRequestAutoMerge(input: { pullRequestId: $prId, mergeMethod: SQUASH }) { clientMutationId }
                }
              `, { prId: nodeId });
              core.info('Auto-merge enabled.');
            } catch (e) {
              core.warning(`Could not enable auto-merge (is it enabled in repo settings?): ${e.message}`);
            }

      - name: Set PR labels (optional)
        if: steps.pr.outputs.number != ''
        uses: actions/github-script@v8
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const number = Number('${{ steps.pr.outputs.number }}');
            try {
              await github.rest.issues.addLabels({ owner, repo, issue_number: number, labels: ['automerge', 'ci'] });
            } catch (e) {
              core.warning(`Could not add labels (may not exist): ${e.message}`);
            }
