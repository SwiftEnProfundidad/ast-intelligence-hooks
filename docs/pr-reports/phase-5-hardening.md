# Phase 5 - Refactor Hardening and Type Safety

## Objective

Reduce integration duplication, wire AST heuristic pilot flag safely, and stabilize production typecheck baseline.

## Commits

- `e0fce26` refactor(git): centralize upstream and CI base ref resolution
- `9ab86b6` refactor(git): deduplicate stage runners across platforms
- `5b5aae3` refactor(git): centralize CLI exit handling for stage runners
- `8cdafcc` feat(backend-rules): add typed backend baseline ruleset
- `49d2b18` refactor(ci): use reusable workflow for platform gates
- `d8f1220` chore(heuristics): add feature flag wiring for semantic pilot
- `3ef5f42` chore(ci): support AST heuristics flag in reusable gate workflow
- `18b151a` feat(heuristics): add AST empty-catch pilot behind feature flag
- `7207567` feat(heuristics): add explicit-any AST pilot check
- `a4ae585` fix(heuristics): scope AST pilot to frontend and skip test files
- `0985570` test(heuristics): add cross-platform AST pilot coverage
- `8620ed7` ci(heuristics): add dedicated AST pilot test workflow
- `903c4d0` feat(evidence): add human intent state with deterministic expiry enforcement
- `3fa5d04` refactor(evidence): centralize human intent normalization and expiry logic
- `67b5417` docs(evidence): unify references to .ai_evidence.json
- `573c65f` feat(ast): introduce typed heuristic facts in extraction flow
- `254849c` refactor(heuristics): evaluate typed heuristic facts through rule packs
- `7395c42` refactor(evidence): add canonical generateEvidence writer path
- `04f9a01` docs(heuristics): document declarative AST rule pack and evidence bundle
- `54c55a2` docs(architecture): add conceptual entrypoint and manual hook-system usage
- `82cb873` ci(tests): unify deterministic suite for evidence mcp and heuristics
- `08b3930` feat(heuristics): extend TypeScript AST pilot coverage to backend paths
- `2d25f94` fix(types): align dependency fact source and gate readonly handling
- `71dadb6` chore(tsconfig): exclude nested test files from production typecheck
- `89f8bd0` feat(heuristics): add stage-based severity maturity across gates
- `f2a35e2` test(gate): verify stage-based heuristic blocking behavior
- `3f9948c` fix(evidence): align snapshot outcome with gate decision
- `610fec0` feat(heuristics): promote iOS AnyView heuristic to ERROR for PRE_PUSH and CI
- `05a5352` feat(heuristics): promote explicit-any heuristic to ERROR for PRE_PUSH and CI
- `d51bb6a` feat(heuristics): promote iOS callback-style heuristic to ERROR for PRE_PUSH and CI
- `9ce666d` feat(evidence): consolidate equivalent baseline/heuristic families in snapshot output
- `d016045` feat(evidence): add consolidation trace metadata
- `6105862` test(evidence): add file-level consolidation fixture
- `a1ac55a` fix(hooks): harden Windsurf cascade hook runtime resolution with deterministic Node wrapper
- `b336c5e` feat(hooks): add strict and diagnostic modes to Windsurf node wrapper
- `b36dfd9` fix(evidence): enforce deterministic file-level consolidation across lines
- `637f114` docs(phase-5): append latest hardening commit traceability
- `d9d2057` docs(hooks): define staged rollout for Windsurf node runtime hardening
- `2407748` feat(hooks): add runtime diagnostics collector for Windsurf cascade hooks
- `af5f97c` docs(evidence): clarify file-level consolidation scope in v2.1
- `e5d7ca6` docs(phase-5): append evidence scope clarification commit
- `dbfb637` docs(validation): add Windsurf hook runtime execution checklist
- `09eca70` docs(phase-5): append validation checklist traceability
- `e088407` docs(validation): capture local Windsurf hook runtime simulation
- `07c307a` feat(hooks): add repeatable local Windsurf runtime validation command
- `d8b82f2` docs(phase-5): append local runtime command traceability
- `2d8142e` feat(hooks): add Windsurf hooks config generator with absolute paths
- `a6e6972` docs(phase-5): append Windsurf config generator traceability
- `1c42851` feat(hooks): add Windsurf hooks config installer with backup
- `02fccf9` docs(phase-5): append Windsurf installer traceability
- `1fcf8e6` feat(hooks): add Windsurf runtime verifier and path fallback
- `5f7b03d` docs(phase-5): append Windsurf verifier traceability
- `c954e99` fix(hooks): resolve pre-write AST loader across scripts and legacy layouts
- `37a2458` docs(phase-5): append pre-write loader fallback traceability
- `d39e508` feat(hooks): add automated Windsurf session log assessment
- `c124254` docs(phase-5): append automated session assessment traceability
- `be9380e` feat(hooks): distinguish real vs simulated Windsurf session assessment

## Scope

- Shared stage runner helpers:
  - `integrations/git/stageRunners.ts`
  - `integrations/git/resolveGitRefs.ts`
  - `integrations/git/runCliCommand.ts`
- Backend typed baseline:
  - `core/rules/presets/backendRuleSet.ts`
- Reusable gate workflow:
  - `.github/workflows/pumuki-gate-template.yml`
- Heuristics test workflow:
  - `.github/workflows/pumuki-heuristics-tests.yml`
  - `package.json` script: `test:heuristics`
- Evidence test workflow:
  - `.github/workflows/pumuki-evidence-tests.yml`
  - `package.json` scripts: `test:evidence`, `test:mcp`, `test:deterministic`
- Heuristics pilot flag:
  - `integrations/config/heuristics.ts`
  - `PUMUKI_ENABLE_AST_HEURISTICS`
  - Evidence bundle version: `astHeuristicsRuleSet@0.2.0`
- Pilot heuristic implementation:
  - `core/facts/HeuristicFact.ts`
  - `core/facts/extractHeuristicFacts.ts`
  - `core/rules/Condition.ts` (`kind: Heuristic`)
  - `core/gate/conditionMatches.ts` (heuristic matcher)
  - `core/rules/presets/astHeuristicsRuleSet.ts`
  - Integration adapter removed; stage runners consume `core/facts/extractHeuristicFacts.ts` directly
  - `integrations/git/runPlatformGate.ts` (single evaluator path for baseline + heuristic rules)
  - `heuristics.ts.empty-catch.ast` (TS/JS empty `catch {}` via AST parser)
  - `heuristics.ts.explicit-any.ast` (TS/TSX explicit `any` via AST parser)
  - `heuristics.ts.console-log.ast` (semantic detection of `console.log(...)` calls)
  - `heuristics.ios.force-unwrap.ast` (token-aware Swift force unwrap detection)
  - `heuristics.ios.anyview.ast` (token-aware Swift `AnyView` usage detection)
  - `heuristics.ios.callback-style.ast` (token-aware `@escaping` callback signature detection outside bridge layers)
  - `heuristics.android.thread-sleep.ast` (token-aware Kotlin `Thread.sleep(...)` detection in production paths)
  - `heuristics.android.globalscope.ast` (token-aware Kotlin `GlobalScope.launch/async/...` detection in production paths)
  - `heuristics.android.run-blocking.ast` (token-aware Kotlin `runBlocking(...)` detection in production paths)
  - Scope hardening: frontend/web/backend, iOS, and Android production paths, excluding test paths
- Type safety hardening:
  - `core/facts/DependencyFact.ts` now includes `source`
  - `integrations/git/evaluateStagedIOS.ts` handles readonly findings safely
  - `tsconfig.json` excludes nested test files from production compile target
- Stage-aware heuristic severity maturity:
  - `integrations/gate/stagePolicies.ts` promotes selected heuristic rules to `ERROR` for `PRE_PUSH` and `CI`
  - `integrations/git/runPlatformGate.ts` applies stage-aware heuristic severities before merged rule evaluation and evidence hashing
  - `integrations/gate/__tests__/stagePolicies.test.ts` covers policy thresholds and heuristic promotion matrix
- Canonical evidence writer path:
  - `integrations/evidence/generateEvidence.ts` as single build+write facade
  - `integrations/evidence/buildEvidence.ts` deterministic snapshot + ledger merge
  - `integrations/evidence/writeEvidence.ts` stable serialization and relative paths
  - Evidence-level consolidation collapses mapped iOS/backend/frontend baseline+heuristic families to the strongest per-file finding
  - File-level consolidation now also collapses repeated same-rule findings across multiple lines deterministically
  - Optional `consolidation.suppressed[]` trace records removed duplicates for deterministic auditability

## Validation status

- `npx tsc --noEmit` now passes for production sources included in tsconfig.
- `npm run test:heuristics` passes (10/10) for cross-platform AST pilot cases.
- `npx --yes tsx@4.21.0 --test integrations/gate/__tests__/stagePolicies.test.ts` passes for stage policy thresholds and severity promotion behavior.
- Stage policy integration checks confirm promoted heuristics block in `PRE_PUSH` and `CI` while staying non-blocking in `PRE_COMMIT`.
- Stage policy calibration now includes `heuristics.ios.anyview.ast` as promoted (`ERROR`) for `PRE_PUSH` and `CI`.
- Stage policy calibration now includes `heuristics.ts.explicit-any.ast` as promoted (`ERROR`) for `PRE_PUSH` and `CI`.
- Stage policy calibration now includes `heuristics.ios.callback-style.ast` as promoted (`ERROR`) for `PRE_PUSH` and `CI`.
- `npm run test:evidence` covers evidence consolidation for iOS and backend semantic families, keeping the strongest deterministic signal.
- Evidence tests now include explicit file-level consolidation fixture with differing line metadata to document current precedence behavior.
- Evidence tests now include repeated same-rule multi-line fixture to enforce deterministic file-level collapse behavior.
- Evidence v2.1 docs now explicitly state file-level consolidation scope for semantic families (including same-rule multi-line occurrences).
- Windsurf cascade hook template now invokes `run-hook-with-node.sh`, validated in minimal shell PATH contexts.
- Windsurf cascade-hook docs now include phased rollout guidance (compatibility -> diagnostics -> strict mode) for runtime hardening.
- Added `collect-runtime-diagnostics.sh` helper to capture wrapper diagnostics and local smoke logs under `.audit_tmp/`.
- Added `docs/validation/windsurf-hook-runtime-validation.md` as the canonical checklist for real-session Windsurf validation.
- Added local simulated runtime validation report (`docs/validation/windsurf-hook-runtime-local-report.md`) and artifacts for pre/post hook behavior.
- Added `validate:windsurf-hooks-local` npm command backed by `validate-local-runtime.sh` for repeatable local runtime validation.
- Added `print:windsurf-hooks-config` npm command to generate non-stale absolute Windsurf hook config.
- Added `install:windsurf-hooks-config` npm command to install refreshed Windsurf config with backup support.
- Added `verify:windsurf-hooks-runtime` npm command to validate hooks wiring and runtime before IDE session.
- Hardened wrapper/config tooling for mixed repo layouts by resolving both `scripts/...` and `legacy/scripts/...` paths.
- Added `assess:windsurf-hooks-session` npm command to auto-assess real-session pre/post hook event presence from logs.
- `assess:windsurf-hooks-session:any` validated with current local logs (`session-assessment=PASS`).
- `assess:windsurf-hooks-session` now excludes simulated + cross-repo events and correctly returns `session-assessment=FAIL` until a real Windsurf session happens in this repo.
- `npm run test:evidence` passes for evidence/human-intent deterministic behavior.
- `npm run test:deterministic` passes (evidence + MCP + heuristics).
- Stage gates and CI workflows keep existing behavior by default.
