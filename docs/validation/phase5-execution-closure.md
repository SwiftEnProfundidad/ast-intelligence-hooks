# Phase 5 Execution Closure Runbook

## Purpose

Close the remaining manual blockers for Phase 5 rollout validation using deterministic generated reports, without coupling gate runtime behavior to IDE-specific adapters.

## Scope

This runbook is operational. It validates rollout readiness and incident closure evidence. It does not change PRE_COMMIT, PRE_PUSH, or CI gate outcomes in this repository.

## One-shot orchestration command

Use this command to run the full closure flow end-to-end:

```bash
npm run validation:phase5-execution-closure -- \
  --repo <owner>/<repo> \
  --out-dir .audit-reports/phase5 \
  --skip-workflow-lint
```

Default behavior includes an auth/scope preflight (`check-consumer-ci-auth`) and stops before triage when auth is blocked.

Strict adapter mode:

```bash
npm run validation:phase5-execution-closure -- \
  --repo <owner>/<repo> \
  --out-dir .audit-reports/phase5 \
  --repo-path /absolute/path/to/consumer-repo \
  --actionlint-bin /tmp/actionlint-bin/actionlint \
  --require-adapter-readiness
```

Generated orchestration summary:

- `.audit-reports/phase5/phase5-execution-closure-run-report.md`

Optional: disable auth preflight when you intentionally want triage to execute auth internally:

```bash
npm run validation:phase5-execution-closure -- \
  --repo <owner>/<repo> \
  --out-dir .audit-reports/phase5 \
  --skip-workflow-lint \
  --skip-auth-preflight
```

Mock-consumer mode (local, no external GH dependency):

```bash
npm run validation:phase5-execution-closure -- \
  --repo <owner>/<repo> \
  --out-dir .audit-reports/phase5 \
  --mock-consumer
```

This mode consumes local package-smoke summaries:

- `.audit-reports/package-smoke/block/summary.md`
- `.audit-reports/package-smoke/minimal/summary.md`
- `.audit-reports/package-smoke/block/ci.ai_evidence.json`
- `.audit-reports/package-smoke/minimal/ci.ai_evidence.json`

and emits local A/B readiness evidence:

- `.audit-reports/phase5/mock-consumer-ab-report.md`

CI coverage:

- `.github/workflows/pumuki-phase5-mock.yml`

## Required Inputs

- Consumer startup triage report (external consumer repository diagnostics):
  - `.audit-reports/consumer-triage/consumer-startup-triage-report.md`

Optional adapter diagnostics input:

- Adapter real-session runtime report:
  - `.audit-reports/adapter/adapter-real-session-report.md`

## Step 1: Generate/refresh Adapter report

Run in this repository:

```bash
npm run validation:adapter-session-status -- --out .audit-reports/adapter/adapter-session-status.md
npm run validation:adapter-real-session-report -- \
  --status-report .audit-reports/adapter/adapter-session-status.md \
  --out .audit-reports/adapter/adapter-real-session-report.md
```

If strict runtime checks fail with `node: command not found`, execute:

- `docs/validation/adapter-hook-runtime-validation.md`

and regenerate both reports.

## Step 2: Generate adapter readiness report (optional but recommended)

```bash
npm run validation:adapter-readiness -- \
  --adapter-report .audit-reports/adapter/adapter-real-session-report.md \
  --out .audit-reports/adapter/adapter-readiness.md
```

Expected adapter verdict when runtime is healthy:

- `READY`

If verdict is `BLOCKED` or `PENDING`, resolve the next-actions section in that report and regenerate it.

## Step 3: Generate/refresh consumer startup triage

Run against consumer repository context:

```bash
npm run validation:consumer-startup-triage -- \
  --repo <owner>/<repo> \
  --out-dir .audit-reports/phase5 \
  --skip-workflow-lint
```

For local mock-consumer closure, this step is generated by `--mock-consumer` orchestration.

Optional with workflow lint:

```bash
npm run validation:consumer-startup-triage -- \
  --repo <owner>/<repo> \
  --repo-path /absolute/path/to/consumer-repo \
  --actionlint-bin /tmp/actionlint-bin/actionlint
```

## Step 4: Consolidate Phase 5 blockers readiness

```bash
npm run validation:phase5-blockers-readiness -- \
  --consumer-triage-report .audit-reports/phase5/consumer-startup-triage-report.md \
  --out .audit-reports/phase5/phase5-blockers-readiness.md
```

Optional strict adapter mode:

```bash
npm run validation:phase5-blockers-readiness -- \
  --require-adapter-report \
  --adapter-report .audit-reports/adapter/adapter-real-session-report.md \
  --consumer-triage-report .audit-reports/phase5/consumer-startup-triage-report.md \
  --out .audit-reports/phase5/phase5-blockers-readiness.md
```

Expected verdict to close Phase 5 execution:

- `READY`

If verdict is `BLOCKED` or `MISSING_INPUTS`, follow the next-actions section in generated report and rerun.

## Step 5: Generate execution-closure status snapshot

```bash
npm run validation:phase5-execution-closure-status -- \
  --phase5-blockers-report .audit-reports/phase5/phase5-blockers-readiness.md \
  --consumer-unblock-report .audit-reports/phase5/consumer-startup-unblock-status.md \
  --out .audit-reports/phase5/phase5-execution-closure-status.md
```

Optional strict adapter mode:

```bash
npm run validation:phase5-execution-closure-status -- \
  --phase5-blockers-report .audit-reports/phase5/phase5-blockers-readiness.md \
  --consumer-unblock-report .audit-reports/phase5/consumer-startup-unblock-status.md \
  --adapter-readiness-report .audit-reports/adapter/adapter-readiness.md \
  --require-adapter-readiness \
  --out .audit-reports/phase5/phase5-execution-closure-status.md
```

## Exit Criteria

Phase 5 execution closure is complete when all are true:

- `.audit-reports/phase5/phase5-blockers-readiness.md` exists with `- verdict: READY`
- `.audit-reports/phase5/phase5-execution-closure-status.md` exists with `- verdict: READY`
- `docs/TODO.md` Phase 5 execution closure item is marked complete
- Relevant rollout/report docs include links to final generated artifacts

## Quick Checklist

- [ ] `validation:adapter-real-session-report` generated and reviewed
- [ ] `validation:adapter-readiness` generated and reviewed
- [ ] `validation:consumer-startup-triage` generated against target repo
- [ ] `validation:phase5-blockers-readiness` returns `verdict=READY`
- [ ] `validation:phase5-execution-closure-status` returns `verdict=READY`
- [ ] mock-consumer A/B report exists with `verdict=READY` when using `--mock-consumer`
- [ ] `docs/TODO.md` execution-closure item updated

## Related References

- `docs/validation/adapter-hook-runtime-validation.md`
- `docs/validation/consumer-ci-startup-failure-playbook.md`
- `docs/validation/skills-rollout-consumer-repositories.md`
- `docs/TODO.md`
