# =============================================================================
# Pre-commit Framework Configuration
# =============================================================================
# Purpose: Inviolable hooks that cannot be bypassed with --no-verify
# Author: Pumuki Team¬Æ
# Documentation: https://pre-commit.com
# =============================================================================

# Fail fast mode - stop on first failure
fail_fast: false

# Default language version
default_language_version:
  python: python3
  node: system

# Global file exclusions
exclude: |
  (?x)^(
    \.git/|
    \.audit-reports/|
    \.audit_tmp/|
    node_modules/|
    \.next/|
    dist/|
    build/|
    coverage/|
    \.vscode/|
    \.idea/
  )

repos:
  # =============================================================================
  # 1. AI EVIDENCE VALIDATION (Priority P0 - Cannot be bypassed)
  # =============================================================================
  - repo: local
    hooks:
      - id: validate-ai-evidence
        name: ü§ñ Validate AI Evidence (MANDATORY)
        entry: bash scripts/hooks-system/infrastructure/shell/validators/validate-ai-protocol.sh
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]
        verbose: true

      - id: validate-ai-evidence-age
        name: ‚è∞ Check AI Evidence Freshness
        entry: bash -c 'bash scripts/hooks-system/infrastructure/shell/validators/validate-ai-protocol.sh --check-age-only'
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]

  # =============================================================================
  # 2. GIT FLOW ENFORCEMENT (Priority P0)
  # =============================================================================
  - repo: local
    hooks:
      # Gitflow enforcer removed - using pre-commit framework instead
      # Old enforcer was deleted (chapucero, could be bypassed)

      - id: prevent-direct-push-to-main
        name: üõ°Ô∏è Prevent Direct Push to Main
        entry: bash -c 'if [ "$(git symbolic-ref --short HEAD)" = "main" ]; then echo "‚ùå Direct push to main is forbidden"; exit 1; fi'
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-push]

      - id: prevent-direct-push-to-develop
        name: üõ°Ô∏è Prevent Direct Commit to Develop
        entry: bash -c 'if [ "$(git symbolic-ref --short HEAD)" = "develop" ]; then echo "‚ùå Direct commit to develop is forbidden. Use feature branch."; exit 1; fi'
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]

      - id: protect-critical-docs
        name: üìö Protect Critical Documentation
        entry: bash scripts/hooks-system/infrastructure/shell/validators/ensure-critical-docs.sh
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: enforce-doc-structure
        name: üóÇÔ∏è Enforce Hook-System Doc Structure
        entry: bash scripts/hooks-system/infrastructure/shell/validators/check-doc-structure.sh
        language: system
        pass_filenames: false
        stages: [pre-commit]

  # =============================================================================
  # 3. CODE QUALITY (Priority P1)
  # =============================================================================
  - repo: local
    hooks:
      - id: eslint-check
        name: üîç ESLint (TypeScript/JavaScript)
        entry: bash -c 'if command -v npm &> /dev/null; then npm run lint:check 2>&1 | head -50 || true; fi'
        language: system
        types: [javascript, jsx, ts, tsx]
        pass_filenames: false
        stages: [pre-commit]

      - id: typescript-check
        name: üìò TypeScript Type Check
        entry: bash -c 'if command -v npm &> /dev/null && [ -f "tsconfig.json" ]; then npm run type-check 2>&1 | head -30 || true; fi'
        language: system
        types: [ts, tsx]
        pass_filenames: false
        stages: [pre-commit]

  # =============================================================================
  # 4. SECURITY CHECKS (Priority P0)
  # =============================================================================
  - repo: local
    hooks:
      - id: detect-secrets
        name: üîê Detect Hardcoded Secrets
        entry: scripts/hooks-system/infrastructure/shell/security/detect-secrets.sh
        language: system
        pass_filenames: false
        stages: [pre-commit]

  # =============================================================================
  # 5. FILE HYGIENE (Priority P2)
  # =============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: check-merge-conflict
        name: üîÄ Check for Merge Conflict Markers
        stages: [pre-commit]

      - id: trailing-whitespace
        name: ‚úÇÔ∏è  Trim Trailing Whitespace
        exclude: '\.md$'

      - id: end-of-file-fixer
        name: üìÑ Fix EOF Newline

      - id: check-yaml
        name: ‚úÖ Validate YAML Files
        args: ['--unsafe']

      - id: check-json
        name: ‚úÖ Validate JSON Files

      - id: check-added-large-files
        name: üì¶ Check Large Files (>500KB)
        args: ['--maxkb=500']

      - id: mixed-line-ending
        name: üîÑ Fix Line Endings
        args: ['--fix=lf']

      - id: no-commit-to-branch
        name: üõ°Ô∏è Prevent Commits to Protected Branches
        args: ['--branch', 'main']

  # =============================================================================
  # 6. COMMIT MESSAGE VALIDATION (Priority P1)
  # =============================================================================
  - repo: local
    hooks:
      - id: conventional-pre-commit
        name: üìù Validate Commit Message Format
        language: python
        entry: scripts/hooks-system/infrastructure/python/conventional_commit_hook.py
        additional_dependencies:
          - conventional-pre-commit==3.4.0
        pass_filenames: false
        stages: [commit-msg]

# =============================================================================
# CI/CD Configuration
# =============================================================================
ci:
  autofix_commit_msg: 'chore: auto-fix pre-commit violations'
  autofix_prs: true
  autoupdate_commit_msg: 'chore: auto-update pre-commit hooks'
  autoupdate_schedule: weekly
  skip: []
  submodules: false
