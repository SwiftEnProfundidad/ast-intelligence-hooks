#!/usr/bin/env bash

# Pre-push hook: BLOCK push if Git Flow is incomplete

HOOKS_SYSTEM_ROOT="$(cd "$(dirname "$0")/../../scripts/hooks-system" && pwd)"

# Check if we're pushing only tags (read from stdin)
while read local_ref local_sha remote_ref remote_sha; do
  # If pushing a tag (refs/tags/*), allow it
  if [[ "$local_ref" =~ ^refs/tags/ ]]; then
    echo ""
    echo "‚úÖ Tag push detected - allowing release workflow"
    echo ""
    exit 0
  fi
done

echo ""
echo "üîç Validating Git Flow compliance before push..."
echo ""

if ! bash "${HOOKS_SYSTEM_ROOT}/infrastructure/shell/gitflow-enforcer.sh" check; then
  echo ""
  echo "üö® PUSH BLOCKED: Complete Git Flow cycle first"
  echo ""
  echo "Missing steps detected. Complete them before pushing."
  echo ""
  exit 1
fi

echo ""
echo "‚úÖ Git Flow validation passed. Proceeding with push..."
echo ""

exit 0
