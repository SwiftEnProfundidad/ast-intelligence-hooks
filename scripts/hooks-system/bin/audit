#!/usr/bin/env bash
# ===== UNIFIED AUDIT COMMAND =====
# Consolidates all audit functionality into a single command
# Replaces: audit-orchestrator.sh, pumuki-audit.js, run-intelligent-audit.sh

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
HOOKS_SYSTEM_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/../../.." && pwd)"

# Default audit artifact directories to temp to avoid polluting repositories.
# Users/CI can override by setting AUDIT_TMP / AUDIT_REPORTS.
if [[ -z "${AUDIT_TMP:-}" ]]; then
    PROJECT_NAME="$(basename "$REPO_ROOT")"
    AUDIT_TMP="${TMPDIR:-/tmp}/pumuki-audit/${PROJECT_NAME}/.audit_tmp"
    export AUDIT_TMP
fi
if [[ -z "${AUDIT_REPORTS:-}" ]]; then
    PROJECT_NAME="$(basename "$REPO_ROOT")"
    AUDIT_REPORTS="${TMPDIR:-/tmp}/pumuki-audit/${PROJECT_NAME}/.audit-reports"
    export AUDIT_REPORTS
fi

# Import utilities
source "$HOOKS_SYSTEM_DIR/infrastructure/shell/core/constants.sh" 2>/dev/null || true
source "$HOOKS_SYSTEM_DIR/infrastructure/shell/core/utils.sh" 2>/dev/null || true

# Colors (fallback if constants not loaded)
RED=${RED:-'\033[0;31m'}
GREEN=${GREEN:-'\033[0;32m'}
YELLOW=${YELLOW:-'\033[1;33m'}
BLUE=${BLUE:-'\033[0;34m'}
NC=${NC:-'\033[0m'}

show_help() {
    cat << EOF
üêàüíö PUMUKI AUDIT - Unified Quality Analysis Tool

USAGE:
    audit [COMMAND] [OPTIONS]

COMMANDS:
    analyze          Full repository analysis (patterns + ESLint + AST)
    staged           Analyze only staged files (pre-commit mode)
    strict           Strict mode: block on ANY violation (CI/CD)

    patterns         Check for TODO/FIXME/console.log/etc patterns
    eslint           Run ESLint analysis
    ast              Run AST Intelligence analysis

    evidence         Manage .AI_EVIDENCE.json (show, update, reset)
    guard            Manage validation guards (enable, disable, status)
    token            Monitor AI token usage (status, reset, alert)
    git              Git operations and analysis (status, staged, diff)

    rules            Show available AST rules
    config           Show configuration status
    doctor           Run diagnostics and health checks

    help             Show this help

SUBCOMMAND GROUPS:
    üîç Analysis: analyze, staged, strict, patterns, eslint, ast
    üõ°Ô∏è  Guards: evidence, guard, token
    üîß Utilities: git, rules, config, doctor

LEGACY ALIASES (deprecated but supported):
    ai-commit        ‚Üí Use 'staged' instead
    pumuki-audit     ‚Üí Use 'analyze' instead
    run-orchestrator ‚Üí Use 'analyze' instead
    run-intelligent-audit ‚Üí Use 'ast' instead

OPTIONS:
    --platform PLAT  Filter by platform (backend|frontend|ios|android)
    --format FMT     Output format (json|text|table)
    --output FILE    Write results to file
    --verbose        Show detailed output
    --fix            Attempt auto-fix where possible

NAMING CONVENTIONS:
    All new commands use kebab-case (e.g., 'analyze', 'staged')
    Legacy camelCase commands are deprecated but supported

EXAMPLES:
    audit analyze                    # Full analysis
    audit staged                     # Pre-commit check
    audit strict                     # CI/CD mode
    audit patterns --platform backend # Pattern check for backend

EOF
}

run_full_analysis() {
    echo "üîç Running full repository analysis..."
    cd "$REPO_ROOT"

    # Patterns
    echo "üìã Checking patterns..."
    AUDIT_OPTION=5 bash "$HOOKS_SYSTEM_DIR/infrastructure/shell/orchestrators/audit-orchestrator.sh"

    # ESLint
    echo "üîß Running ESLint..."
    AUDIT_OPTION=6 bash "$HOOKS_SYSTEM_DIR/infrastructure/shell/orchestrators/audit-orchestrator.sh"

    # AST
    echo "‚öôÔ∏è  Running AST Intelligence..."
    AUDIT_OPTION=7 bash "$HOOKS_SYSTEM_DIR/infrastructure/shell/orchestrators/audit-orchestrator.sh"

    echo "‚úÖ Full analysis complete"
}

run_staged_analysis() {
    echo "üìù Analyzing staged files..."
    cd "$REPO_ROOT"

    # Use audit-orchestrator.sh option 3 (strict staging only)
    AUDIT_OPTION=3 bash "$HOOKS_SYSTEM_DIR/infrastructure/shell/orchestrators/audit-orchestrator.sh"
}

run_strict_analysis() {
    echo "üö´ Running strict analysis (CI/CD mode)..."
    cd "$REPO_ROOT"

    # Use audit-orchestrator.sh option 2 (strict repo+staging)
    AUDIT_OPTION=2 bash "$HOOKS_SYSTEM_DIR/infrastructure/shell/orchestrators/audit-orchestrator.sh"
}

run_patterns_only() {
    echo "üîç Checking code patterns..."
    cd "$REPO_ROOT"

    AUDIT_OPTION=5 bash "$HOOKS_SYSTEM_DIR/infrastructure/shell/orchestrators/audit-orchestrator.sh"
}

run_eslint_only() {
    echo "üîß Running ESLint analysis..."
    cd "$REPO_ROOT"

    AUDIT_OPTION=6 bash "$HOOKS_SYSTEM_DIR/infrastructure/shell/orchestrators/audit-orchestrator.sh"
}

run_ast_only() {
    echo "‚öôÔ∏è  Running AST Intelligence..."
    cd "$REPO_ROOT"

    AUDIT_OPTION=7 bash "$HOOKS_SYSTEM_DIR/infrastructure/shell/orchestrators/audit-orchestrator.sh"
}

run_pumuki_audit() {
    echo "üêà Running Pumuki global audit..."
    cd "$REPO_ROOT"

    if ! command -v node &> /dev/null; then
        echo "‚ùå Node.js not found"
        exit 1
    fi

    node "$HOOKS_SYSTEM_DIR/bin/pumuki-audit.js"
}

run_evidence_management() {
    echo "üõ°Ô∏è Evidence Management"
    case "${2:-show}" in
        show)
            if [[ -f ".AI_EVIDENCE.json" ]]; then
                echo "üìÑ Current evidence file:"
                cat .AI_EVIDENCE.json | jq '.severity_metrics, .ai_gate, .git_flow' 2>/dev/null || cat .AI_EVIDENCE.json
            else
                echo "‚ùå .AI_EVIDENCE.json not found"
            fi
            ;;
        update)
            echo "üîÑ Updating evidence..."
            bash "$HOOKS_SYSTEM_DIR/bin/update-evidence.sh"
            ;;
        reset)
            echo "‚ö†Ô∏è  Resetting evidence file..."
            rm -f .AI_EVIDENCE.json
            echo "‚úÖ Evidence reset"
            ;;
        *)
            echo "Usage: audit evidence [show|update|reset]"
            ;;
    esac
}

run_guard_management() {
    echo "üõ°Ô∏è Guard Management"
    case "${2:-status}" in
        status)
            echo "Current guard status:"
            echo "  ‚Ä¢ Master Validator: $(bash "$HOOKS_SYSTEM_DIR/infrastructure/guards/master-validator.sh" --dry-run 2>&1 | grep -o "PASSED\|FAILED\|BLOCKED" || echo "unknown")"
            ;;
        enable)
            echo "Enabling guards..."
            # Implementation would go here
            echo "‚úÖ Guards enabled"
            ;;
        disable)
            echo "‚ö†Ô∏è  Disabling guards..."
            # Implementation would go here
            echo "‚ö†Ô∏è  Guards disabled"
            ;;
        *)
            echo "Usage: audit guard [status|enable|disable]"
            ;;
    esac
}

run_token_monitoring() {
    echo "üé´ Token Monitoring"
    case "${2:-status}" in
        status)
            if [[ -f ".audit_tmp/token-usage.jsonl" ]]; then
                LAST_USAGE=$(tail -1 .audit_tmp/token-usage.jsonl 2>/dev/null)
                if [[ -n "$LAST_USAGE" ]]; then
                    PERCENT=$(echo "$LAST_USAGE" | jq -r '.percentUsed' 2>/dev/null || echo "0")
                    ESTIMATED=$(echo "$LAST_USAGE" | jq -r '.estimated' 2>/dev/null || echo "0")
                    echo "üìä Token Usage: ${ESTIMATED}K tokens (${PERCENT}%)"
                    if (( $(echo "$PERCENT > 85" | bc -l 2>/dev/null || echo 0) )); then
                        echo "‚ö†Ô∏è  High usage - consider wrapping up session"
                    fi
                else
                    echo "No token usage data available"
                fi
            else
                echo "Token usage tracking not initialized"
            fi
            ;;
        reset)
            echo "üîÑ Resetting token counter..."
            rm -f .audit_tmp/token-usage.jsonl
            echo "‚úÖ Token counter reset"
            ;;
        alert)
            echo "üö® Token Alert Settings:"
            echo "  ‚Ä¢ Warning threshold: 75%"
            echo "  ‚Ä¢ Critical threshold: 90%"
            echo "  ‚Ä¢ Auto-notification: enabled"
            ;;
        *)
            echo "Usage: audit token [status|reset|alert]"
            ;;
    esac
}

run_git_operations() {
    echo "üîß Git Operations"
    case "${2:-status}" in
        status)
            echo "üìä Git Status:"
            git status --short
            echo ""
            echo "üìù Staged files:"
            git diff --cached --name-only | sed 's/^/  ‚Ä¢ /' || echo "  None"
            ;;
        staged)
            echo "üìù Staged Files Analysis:"
            STAGED=$(git diff --cached --name-only | wc -l | tr -d ' ')
            echo "  ‚Ä¢ Files staged: $STAGED"
            if [[ "$STAGED" -gt 0 ]]; then
                echo "  ‚Ä¢ File list:"
                git diff --cached --name-only | sed 's/^/    - /'
            fi
            ;;
        diff)
            echo "üìã Git Diff (staged):"
            git diff --cached --stat
            ;;
        *)
            echo "Usage: audit git [status|staged|diff]"
            ;;
    esac
}

run_config_status() {
    echo "‚öôÔ∏è Configuration Status"
    echo ""

    CONFIG_FILES=(
        ".AI_EVIDENCE.json:AI Evidence file"
        ".audit_tmp/:Temporary directory"
        ".audit-reports/:Reports directory"
        "scripts/hooks-system/config/rules.json:AST Rules"
        "scripts/hooks-system/config/paths.conf:Path configuration"
        ".pre-commit-config.yaml:Pre-commit hooks"
    )

    for config_entry in "${CONFIG_FILES[@]}"; do
        IFS=':' read -r file_path description <<< "$config_entry"
        if [[ -e "$file_path" ]]; then
            echo "‚úÖ $description: $file_path"
        else
            echo "‚ùå $description: $file_path (missing)"
        fi
    done

    echo ""
    echo "üîß Environment Variables:"
    echo "  ‚Ä¢ ENABLE_INTELLIGENT_SEVERITY: ${ENABLE_INTELLIGENT_SEVERITY:-not set}"
    echo "  ‚Ä¢ DEBUG_AUDIT: ${DEBUG_AUDIT:-not set}"
    echo "  ‚Ä¢ PRE_COMMIT: ${PRE_COMMIT:-not set}"
}

run_diagnostics() {
    echo "üîç Running Hook System Diagnostics..."
    echo ""

    # Check required tools
    echo "üõ†Ô∏è  Tool Availability:"
    tools=(node npm git jq)
    for tool in "${tools[@]}"; do
        if command -v "$tool" &> /dev/null; then
            version=$("$tool" --version 2>/dev/null | head -1)
            echo "  ‚úÖ $tool: $version"
        else
            echo "  ‚ùå $tool: not found"
        fi
    done

    echo ""
    echo "üìÅ Directory Structure:"
    dirs=(".audit_tmp" ".audit-reports" "scripts/hooks-system" "node_modules")
    for dir in "${dirs[@]}"; do
        if [[ -d "$dir" ]]; then
            echo "  ‚úÖ $dir: exists"
        else
            echo "  ‚ùå $dir: missing"
        fi
    done

    echo ""
    echo "üîó Integration Status:"
    if [[ -f ".pre-commit-config.yaml" ]]; then
        if grep -q "master-validator" .pre-commit-config.yaml; then
            echo "  ‚úÖ Pre-commit hooks: configured"
        else
            echo "  ‚ö†Ô∏è  Pre-commit hooks: not configured for hook-system"
        fi
    else
        echo "  ‚ùå Pre-commit config: not found"
    fi

    if [[ -f ".AI_EVIDENCE.json" ]]; then
        echo "  ‚úÖ AI Evidence: initialized"
    else
        echo "  ‚ö†Ô∏è  AI Evidence: not initialized"
    fi

    echo ""
    echo "üéØ Quick Test:"
    # Test basic audit functionality
    if node scripts/hooks-system/bin/run-ast-adapter.js --help &>/dev/null; then
        echo "  ‚úÖ AST Adapter: functional"
    else
        echo "  ‚ùå AST Adapter: not functional"
    fi

    echo ""
    echo "üí° Recommendations:"
    echo "  ‚Ä¢ Run 'audit analyze' for full system test"
    echo "  ‚Ä¢ Check .AI_EVIDENCE.json for detailed metrics"
    echo "  ‚Ä¢ Use 'audit doctor' for ongoing health monitoring"
}

show_rules() {
    echo "üìã Available AST Rules:"
    echo ""

    # Try to extract rules from config
    if [[ -f "$HOOKS_SYSTEM_DIR/config/rules.json" ]]; then
        if command -v jq &> /dev/null; then
            jq -r 'keys[]' "$HOOKS_SYSTEM_DIR/config/rules.json" | while read -r rule; do
                echo "  ‚Ä¢ $rule"
            done
        else
            echo "  Install jq to see detailed rules list"
        fi
    else
        echo "  Rules configuration not found"
    fi

    echo ""
    echo "Common categories:"
    echo "  ‚Ä¢ Clean Architecture violations"
    echo "  ‚Ä¢ TypeScript strict mode issues"
    echo "  ‚Ä¢ Security vulnerabilities"
    echo "  ‚Ä¢ Performance problems"
    echo "  ‚Ä¢ Code quality issues"
}

# Main command router
case "${1:-help}" in
    # Primary commands (standardized naming)
    analyze|full)
        run_full_analysis
        ;;
    staged|pre-commit)
        run_staged_analysis
        ;;
    strict|ci|cd)
        run_strict_analysis
        ;;
    patterns|pattern)
        run_patterns_only
        ;;
    eslint|lint)
        run_eslint_only
        ;;
    ast|intelligence)
        run_ast_only
        ;;
    rules|config)
        show_rules
        ;;
    config)
        run_config_status
        ;;
    doctor)
        run_diagnostics
        ;;
    evidence)
        run_evidence_management "$@"
        ;;
    guard)
        run_guard_management "$@"
        ;;
    token)
        run_token_monitoring "$@"
        ;;
    git)
        run_git_operations "$@"
        ;;

    # Legacy compatibility aliases (deprecated but supported)
    ai-commit)
        echo "‚ö†Ô∏è  'ai-commit' is deprecated. Use 'audit staged' instead."
        run_staged_analysis
        ;;
    pumuki|pumuki-audit)
        echo "‚ö†Ô∏è  'pumuki-audit' is deprecated. Use 'audit analyze' instead."
        run_pumuki_audit
        ;;
    orchestrator|run-orchestrator)
        echo "‚ö†Ô∏è  'run-orchestrator' is deprecated. Use 'audit analyze' instead."
        run_full_analysis
        ;;
    intelligent-audit|run-intelligent-audit)
        echo "‚ö†Ô∏è  'run-intelligent-audit' is deprecated. Use 'audit ast' instead."
        ENABLE_INTELLIGENT_SEVERITY=true run_ast_only
        ;;

    help|--help|-h)
        show_help
        ;;
    *)
        echo "‚ùå Unknown command: $1"
        echo ""
        show_help
        exit 1
        ;;
esac
