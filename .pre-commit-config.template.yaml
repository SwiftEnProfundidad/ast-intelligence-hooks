# =============================================================================
# Pre-commit Framework Configuration
# =============================================================================
# Purpose: Inviolable hooks that cannot be bypassed with --no-verify
# Author: Pumuki TeamÂ®
# Documentation: https://pre-commit.com
# =============================================================================

# Fail fast mode - stop on first failure
fail_fast: false

# Default language version
default_language_version:
  python: python3
  node: system

# Global file exclusions
exclude: |
  (?x)^(
    \.git/|
    \.audit-reports/|
    \.audit_tmp/|
    node_modules/|
    \.next/|
    dist/|
    build/|
    coverage/|
    \.vscode/|
    \.idea/
  )

repos:
  # =============================================================================
  # 1. AI EVIDENCE VALIDATION (Priority P0 - Cannot be bypassed)
  # =============================================================================
  - repo: local
    hooks:
      - id: validate-ai-evidence
        name: ğŸ¤– Validate AI Evidence (MANDATORY)
        entry: bash scripts/hooks-system/infrastructure/shell/validators/validate-ai-protocol.sh
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]
        verbose: true

      - id: validate-ai-evidence-age
        name: â° Check AI Evidence Freshness
        entry: bash -c 'bash scripts/hooks-system/infrastructure/shell/validators/validate-ai-protocol.sh --check-age-only'
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]

  # =============================================================================
  # 2. GIT FLOW ENFORCEMENT (Priority P0)
  # =============================================================================
  - repo: local
    hooks:
      # Gitflow enforcer removed - using pre-commit framework instead
      # Old enforcer was deleted (chapucero, could be bypassed)

      - id: prevent-direct-push-to-main
        name: ğŸ›¡ï¸ Prevent Direct Push to Main
        entry: bash -c 'if [ "$(git symbolic-ref --short HEAD)" = "main" ]; then echo "âŒ Direct push to main is forbidden"; exit 1; fi'
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-push]

      - id: prevent-direct-push-to-develop
        name: ğŸ›¡ï¸ Prevent Direct Commit to Develop
        entry: bash -c 'if [ "$(git symbolic-ref --short HEAD)" = "develop" ]; then echo "âŒ Direct commit to develop is forbidden. Use feature branch."; exit 1; fi'
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]

  # =============================================================================
  # 3. CODE QUALITY (Priority P1)
  # =============================================================================
  - repo: local
    hooks:
      - id: eslint-check
        name: ğŸ” ESLint (TypeScript/JavaScript)
        entry: bash -c 'if command -v npm &> /dev/null; then npm run lint:check 2>&1 | head -50 || true; fi'
        language: system
        types: [javascript, jsx, ts, tsx]
        pass_filenames: false
        stages: [pre-commit]

      - id: typescript-check
        name: ğŸ“˜ TypeScript Type Check
        entry: bash -c 'if command -v npm &> /dev/null && [ -f "tsconfig.json" ]; then npm run type-check 2>&1 | head -30 || true; fi'
        language: system
        types: [ts, tsx]
        pass_filenames: false
        stages: [pre-commit]

  # =============================================================================
  # 4. SECURITY CHECKS (Priority P0)
  # =============================================================================
  - repo: local
    hooks:
      - id: detect-secrets
        name: ğŸ” Detect Hardcoded Secrets
        entry: bash -c 'grep -rn --include="*.ts" --include="*.js" --include="*.tsx" --include="*.jsx" -E "(password|secret|api_key|token|bearer)\s*[:=]" . | grep -v "node_modules" | grep -v ".git" | head -20 || true'
        language: system
        pass_filenames: false
        stages: [pre-commit]

      - id: check-merge-conflict
        name: ğŸ”€ Check for Merge Conflict Markers
        entry: bash -c 'if git diff --cached | grep -E "^(\<\<\<\<\<\<\<|\>\>\>\>\>\>\>|=======)"; then echo "âŒ Merge conflict markers detected"; exit 1; fi'
        language: system
        always_run: true
        pass_filenames: false
        stages: [pre-commit]

  # =============================================================================
  # 5. FILE HYGIENE (Priority P2)
  # =============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v4.5.0
    hooks:
      - id: trailing-whitespace
        name: âœ‚ï¸  Trim Trailing Whitespace
        exclude: '\.md$'

      - id: end-of-file-fixer
        name: ğŸ“„ Fix EOF Newline

      - id: check-yaml
        name: âœ… Validate YAML Files
        args: ['--unsafe']

      - id: check-json
        name: âœ… Validate JSON Files

      - id: check-added-large-files
        name: ğŸ“¦ Check Large Files (>500KB)
        args: ['--maxkb=500']

      - id: mixed-line-ending
        name: ğŸ”„ Fix Line Endings
        args: ['--fix=lf']

      - id: no-commit-to-branch
        name: ğŸ›¡ï¸ Prevent Commits to Protected Branches
        args: ['--branch', 'main']

  # =============================================================================
  # 6. COMMIT MESSAGE VALIDATION (Priority P1)
  # =============================================================================
  - repo: https://github.com/compilerla/conventional-pre-commit
    rev: v3.4.0
    hooks:
      - id: conventional-pre-commit
        name: ğŸ“ Validate Commit Message Format
        stages: [commit-msg]

# =============================================================================
# CI/CD Configuration
# =============================================================================
ci:
  autofix_commit_msg: 'chore: auto-fix pre-commit violations'
  autofix_prs: true
  autoupdate_commit_msg: 'chore: auto-update pre-commit hooks'
  autoupdate_schedule: weekly
  skip: []
  submodules: false
